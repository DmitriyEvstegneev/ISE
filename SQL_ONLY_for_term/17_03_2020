----------------------------17.03, ДОМАШНЯЯ РАБОТА----------------------------

1) Номера деталей, поставляемых для любого проекта, разрабатываемого в Лондоне.

SELECT DISTINCT spj.pn FROM spj
	JOIN j ON spj.jn = j.jn
	WHERE city = 'London';

2) Определить номера проектов, для которых среднее количество поставляемых деталей с номером P1 больше, чем наибольшее количество любых деталей, поставляемых для проекта с номером J1.

// parts_1 – находим номера проектов и среднее количество деталей среди всех поставок детали pn = 1 для данного проекта
// parts_2 – определяем наибольшее количество деталей среди всех поставок для проекта jn = 1
// определяем исходные номера проектов

WITH parts_1 AS (SELECT jn, AVG(qty) AS avg_qty FROM spj WHERE pn = 1 GROUP BY jn),
	parts_2 AS (SELECT MAX(qty) AS max_qty FROM spj WHERE jn = 1)
	SELECT jn FROM parts_1, parts_2 WHERE avg_qty > max_qty;

3) Найти номера проектов, для которых поставщиками из Лондона не поставляется ни одна деталь красного цвета.

SELECT jn FROM j
EXCEPT
SELECT DISTINCT spj.jn FROM spj
	JOIN s ON spj.sn = s.sn
	JOIN p ON spj.pn = p.pn
	WHERE (s.city = 'London' AND p.color = 'Red');

------------------------17.03, САМОСТОЯТЕЛЬНАЯ РАБОТА------------------------
----------------------------------ВАРИАНТ 1----------------------------------

1) Найти все номера проектов, детали для которых поставляются по крайней мере одним поставщиком из другого города.

SELECT DISTINCT spj.jn FROM spj
	JOIN s ON spj.sn = s.sn
	JOIN j ON spj.jn = j.jn
	WHERE s.city <> j.city;

2) Определить общее количество деталей с номером PN в каждом из проектов, в которых участвует поставщик с заданным номером SN.

// pn = 1, sn = 1
// projects_1 – выбираем номера проектов, в которых участвует поставщик sn = 1
// projects_2 – собираем записи о поставках деталей pn = 1 во все проекты projects_1
// определяем суммарное количество деталей для каждого проекта

WITH projects_1 AS (SELECT DISTINCT jn AS s_jn FROM spj WHERE sn = 1),
	projects_2 AS (SELECT spj.jn, spj.qty FROM spj, projects_1
		WHERE (jn = s_jn AND pn = 1))
	SELECT jn, SUM(qty) FROM projects_2 GROUP BY jn;

----------------------------------ВАРИАНТ 2----------------------------------

1) Определить номера деталей, поставляемых для проектов поставщиком из того же города, в котором разрабатывается проект.

SELECT DISTINCT spj.pn FROM spj
	JOIN s ON s.sn = spj.sn
	JOIN j ON j.jn = spj.jn
	WHERE j.city = s.city;

2) Определить общее количество проектов, для каждой детали от поставщика с заданным номером SN.

// parts_1 – выбираем номера деталей, поставляемых поставщиком sn = 5
// parts_2 – выбираем все уникальные сочетания деталей pn и проектов jn
// parts_2_cnt – подсчитываем количество проектов для каждой детали
// выбираем детали parts_1 и количество проектов для каждой из них

WITH parts_1 AS (SELECT DISTINCT pn AS s_pn FROM spj WHERE sn = 5),
	parts_2 AS (SELECT DISTINCT pn, jn FROM spj),
	parts_2_cnt AS (SELECT pn, COUNT(jn) AS count_jn FROM parts_2 GROUP BY pn)
	SELECT pn, count_jn FROM parts_2_cnt, parts_1
		WHERE parts_2_cnt.pn = parts_1.s_pn;

